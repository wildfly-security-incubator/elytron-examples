# client-side-encryption

The `ejb-mutual-tls` example demonstrates how to securely connect to EJBs deployed to WildFly using mutual TLS
authentication, and control access with the SCRAM-SHA-512-PLUS SASL authentication mechanism. We will be building on that example to use client side encryption, which allows sensitive information, like passwords to be defined using encrypted expressions instead of clear-text.

### Overview

In addition to the steps in `ejb-mutual-tls`, this example takes the following steps to perform client side encryption:

1. **Generate Credential Stores for Encrypted Expressions** 

* We will be using PropertiesCredentialStore type credential stores that are backed by a properties file to encrypt our clear-text information. 
* We will be creating this credential store using the WildFly-Elytron tool. 
* We will be generating a secret key which will be used to encrypt and decrypt our clear-texts. We can use a different secret key and resolver for each clear-text and each of them may live inside different credential stores. 

    * Alternatively, we can use different secret keys for each clear-text, but store them all inside the same credential-store.

    * Or, we can also choose to encrypt all clear-text values using the same secret key. 

2. **Encrypt clear-text values**
 
* We will be using the WildFly-Elytron tool to encrypt clear-texts as well. We can use the following command to encrypt a clear-text: 
```
bin/elytron-tool.sh credential-store --location standalone/configuration/store-one.cs --type PropertiesCredentialStore --encrypt key
Clear text value:
Confirm clear text value:
Clear text encrypted to token 'RUxZAUMQvGzk6Vaadp2cahhZ6rlPhHOZcWyjXALlAthrENvRTvQ=' using alias 'key'.
```
* Once we have the the expression encrypted, we can copy it and add it to the authentication client element. We will be encrypting the `key-store-clear-password` attribute inside the `ssl-context` element and the `key-store` elements, along with the credential for the `example_user` user, which initially uses credential-store-reference in the original example. 

3. **Replacing Clear-text Passwords with Encrypted Expressions**

* When specifying element and attribute values using encrypted expressions, we will be using the following format: 
```
    ${ENC::resolver-name:encrypted-expression}
```
* Here, `ENC` is the prefix that tells the parser and resolver that the type of expression used here is an encrypted expression, the `resolver-name`, which is optional is the name of the resolver used to decrypt the expression and `encrypted-expression` is the token generated by the WildFly-Elytron tool in step 2. 

4. **Configure the Encrypted-Expressions client**

* In order for the client configuration to be able to decrypt the encrypted expression, we will be configuring the resolvers and the corresponding credential-stores, which make up the encrypted-expressions client. 

* We will be defining the resolvers which refer to one of the aliases created in step 1 inside the credential stores also created in that step. 

* We will also be defining the default-resolver, which will be used to decrypt expressions when a resolver us not specified. 

Note: Since we are using encrypted expressions to specify the credential for the user, we no longer need a credential store inside the `authentication-client` element. As a result, that step will be skipped.


### Use of WILDFLY_HOME

In the following instructions, replace `WILDFLY_HOME` with the actual path to your WildFly installation.

### Back up the WildFly Standalone Server Configuration

Before you begin, back up your server configuration file.

1. If it is running, stop the WildFly server.
2. Back up the `WILDFLY_HOME/standalone/configuration/standalone.xml` file.

After you have completed testing this example, you can replace this file to restore the server to its original configuration.

### Start the WildFly Server

First, clone the `elytron-examples` repo locally:
```shell
    $ git clone https://github.com/wildfly-security-incubator/elytron-examples
    $ cd elytron-examples
```
Then, start the server:

```shell
    $ WILDFLY_HOME/bin/standalone.sh
```

### Generate the Client Key Pair and Certificate

Open a new terminal, and navigate to the root directory of this example. Generate the client's key pair, and store it locally in a key store as follows:
```shell
    $ keytool -genkeypair -alias client -keyalg RSA -keysize 2048 -validity 365 -keystore /PATH/TO/tlsClient.keystore -dname "CN=client" -storepass clientKeySecret
```

Export the self-signed certificate and save it locally to a certificate file:
```shell
    $ keytool -exportcert -keystore /PATH/TO/tlsClient.keystore -alias client -storepass clientKeySecret -file /PATH/TO/tlsClient.cer
```

_\(Note: self-signed certificates are not suitable for production environments, and are treated as insecure by
most programs. To obtain a certificate signed by a Certificate Authority, take a look at this [blog post](https://wildfly-security.github.io/wildfly-elytron/blog/obtaining-certificates-from-lets-encrypt-using-the-wildfly-cli/).\)_

### Generate Credential Stores for Encrypted Expressions

You can use the following command with the WildFly-Elytron tool to create the credential store: 
```
    WILDFLY_HOME/bin/elytron-tool.sh credential-store --create --location=PATH/TO/mycredstore.cs --type PropertiesCredentialStore
    Credential Store has been successfully created
```
We declared the type to be `PropertiesCredentialStore`, which means when adding the credential-store to client configuration, we will not need to specify its protection parameter in clear-text.

We can now generate secret keys and add them to the credential store using the command below: 
```
    WILDFLY_HOME/bin/elytron-tool.sh credential-store --generate-secret-key=secretkey --location=PATH/TO/mycredstore.cs --type=PropertiesCredentialStore
```
We can generate as many secret keys as needed. However, for this example, we will only need one. 

### Encrypt clear-text values

We will be encrypting the following 3 clear-text values: 
 * Password for the `tlsClientTrustStore` keystore
 * Password for the `tlsClientKeyStore` keystore
 * Password for `example_user` user

We will use the same secret-key to encrypt them all using the following commands: 
```
    WILDFLY_HOME/bin/elytron-tool.sh credential-store --location PATH/TO/mycredstore.cs --type PropertiesCredentialStore --encrypt secretkey
    Clear text value:
    Confirm clear text value:
    Clear text encrypted to token 'RUxZAUMQvGzk6Vaadp2cahhZ6rlPhHOZcWyjXALlAthrENvRTvQ=' using alias 'secretkey'.
```

For each of the values listed above, we will enter them when prompted for the clear-text value. Please note that the token generated will be different than what is displayed above. Now we can use them in the client configuration. 

### Replacing Clear-text Passwords with Encrypted Expressions

Navigate to the wildfly-config.xml file located inside the resources folder for this project. There are 4 fields where we will be making changes. 

* Currently, the password for the `tlsClientTrustStore` keystore is specified as clear-text, which we encrypted in the previous step. This can be used to replace the clear-text password as follows: 
```
    <key-store-clear-password password="${ENC::my-resolver:<Insert token for clientTrustSecret>}"/>
```

* The password for the `tlsClientKeyStore` keystore can be used to replace the clear-text password as follows: 
```
    <key-store-clear-password password="${ENC::my-resolver:<Insert token for clientKeySecret>}"/>
```

* The password for the `example_user` user can be specified as follows: 
```
    <clear-password password="${ENC::my-resolver:<Insert token for examplePwd1!>}"/>
```

* Step 1 can be followed again with the same expression for the password for the `tlsClientKeyStore` keystore under the `ssl-contexts` element. 

### Configure the Encrypted-Expressions client

In order for the parser to be able to decrypt the expression, we need to configure the `encrypted-expressions` client with the credential-store we created in step 1 as well as a resolver that will be used to decrypt the expression. The resolver is backed by the same secret key that is used to encrypt the clear-text values. 

Inside the wildfly-config.xml file, the encrypted-expression client is configured as follows: 
```
    <encrypted-expression xmlns="urn:encrypted:expression:1.0">
        <credential-stores>
            <credential-store name="my-credential-store" type="PropertiesCredentialStore">
                <attributes>
                    <attribute name="location" value="path/to/mycredstore.cs"/>
                </attributes>
            </credential-store>
        </credential-stores>
        <expression-resolvers default-resolver="my-resolver">
            <expression-resolver name="my-resolver" credential-store-name="my-credential-store" alias="secretkey"/>
        </expression-resolvers>
    </encrypted-expression>
```
Replace the value for the location for the credential-store with the actual path to the credential-store. 

### Configure Elytron

Review the `configure-elytron.cli` file in the root of this example directory. This script
adds the configuration that enables Elytron security for the app components. Comments in the script
describe the purpose of each command.

In the section titled `## Server KeyStore and TrustStore ##`, the server generates its own key pair and
certificate, and then imports the client certificate. On the command where the client certificate is
imported into the server's trust store, change `/PATH/TO/` to point to the client's exported certificate, called `tlsClient.cer`:
```
    # Import the client certificate into the trust store. Since the certificate is self-signed, it will not be validated
    /subsystem=elytron/key-store=tlsTrustStore:import-certificate(alias=client,path=/PATH/TO/tlsClient.cer,credential-reference={clear-text=serverTrustSecret},trust-cacerts=true,validate=false)
```

Then, open a new terminal, navigate to the root directory of this example and run the following command,
replacing `WILDFLY_HOME` with the path to your server.

```shell
    $ WILDFLY_HOME/bin/jboss-cli.sh --connect --file=configure-elytron.cli
```

NOTE: For Windows, use the WILDFLY_HOME\bin\jboss-cli.bat` script.

You should see the following result when you run the script:
```shell
    The batch executed successfully
    The batch executed successfully
    The batch executed successfully
    The batch executed successfully
    process-state: reload-required
```

### Import the Server Certificate and Client TLS Configuration

Import the server certificate into the client's trust store, and save the store locally by running the
following command, replacing `WILDFLY_HOME` with the path to your server:
```shell
    $ keytool -importcert -keystore /PATH/TO/tlsClient.truststore -storepass clientTrustSecret -alias localhost -trustcacerts -file /WILDFLY_HOME/standalone/configuration/tlsServer.cer -noprompt
```

In `wildfly-config.xml`, make sure to change the path to your key and trust stores (i.e. replace `/PATH/TO/` with
the path to the key store, and the trust store):
```xml
    <key-stores>
        <key-store name="tlsClientTrustStore" type="PKCS12">
            <file name="/PATH/TO/tlsClient.truststore"/>
            <key-store-clear-password password="clientTrustSecret"/>
        </key-store>
        <key-store name="tlsClientKeyStore" type="PKCS12">
            <file name="/PATH/TO/tlsClient.keystore"/>
            <key-store-clear-password password="clientKeySecret"/>
        </key-store>
    </key-stores>
```

### Build and Deploy the Demo App
1. Make sure you start the WildFly server as described above.
2. Open a new terminal and navigate to the root directory of this example.
3. Type the following command to build the artifacts.
```shell
    $ mvn clean install wildfly:deploy
```

This deploys the `client-side-encryption/target/client-side-encryption.jar` to the running instance of the server.

You should see a message in the server log indicating that the archive deployed successfully.

### Run the Client
Before you run the client, make sure you have successfully deployed the EJBs to the server in
the previous step and that your terminal is still in the root directory of this example.

Run this command to execute the client:
```shell
    $ mvn exec:exec
```

### Investigate the Console Output

When you run the `mvn exec:exec` command, you should see the following output.

```shell
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

Successfully called secured bean, caller principal example_user

Principal has admin permission: false

* * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
```

The server and client were able to verify each other's certificates as matching their trust
stores, as configured in the client-side `wildfly-config.xml` file and the server-side `configure-elytron.cli`
script. Additionally, the username and credentials stored in the credential store were used to log
into the application server, as configured in `wildfly-config.xml`. As expected, the ``example_user``
was able to invoke the method available for the ```guest``` role but not for the ```admin``` role.

### Undeploy the Demo App

1. Make sure you start the WildFly server.
2. Open a terminal to the root directory of this example.
3. Type this command to undeploy the archive:
```bash
    $ mvn wildfly:undeploy
```

### Restore the WildFly Standalone Server Configuration

You can restore the original server configuration by either:
1. Manually restoring the configuration using the backup copy of the configuration file.
2. Modifying and running the restore-configuration.cli script provided in the root directory of this example.

##### Restore the WildFly Standalone Server Configuration by Running the JBoss CLI Script

Perform the following steps to restore the original configuration:

1. Start the WildFly server.
2. Open a new terminal, navigate to the root directory of this example, and run the following command:
```shell
    $ WILDFLY_HOME/bin/jboss-cli.sh --connect --file=restore-configuration.cli
```

NOTE: For Windows, use the ```WILDFLY_HOME\bin\jboss-cli.bat``` script.

You should see the following output when you run the script:

```shell
    The batch executed successfully
    process-state: reload-required 
    The batch executed successfully
    process-state: reload-required 
    The batch executed successfully
    process-state: reload-required 
    The batch executed successfully
    process-state: reload-required 
```

##### Restore the WildFly Standalone Server Configuration Manually
You can also restore the original server configuration
by manually restoring the configuration file with your backup copy.

1. If it is running, stop the WildFly server.

2. Replace the ```WILDFLY_HOME/standalone/configuration/standalone.xml``` file with the backup copy of the file.
